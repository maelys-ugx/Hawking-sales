<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BA payment</title>
    <meta name="description" content="BA payment – Record and calculate daily agent sales." />
    <!-- (Style section identique à avant) -->
  </head>
  <body>
    <!-- (Header, form, table et footer identiques à ton code d’origine) -->

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
      const UGX = (n) => (isFinite(n) ? Math.round(Number(n)) : 0);
      const KG3 = (n) => (isFinite(n) ? Number(n).toFixed(3) : (0).toFixed(3));
      const num = (n) => (n === '' || n === null || n === undefined ? 0 : Number(n));

      const defaults = {
        Kikalayi: { price: 500, weight: 0.03 },
        Skewers: { price: 1000, weight: 0.045 },
      };

      const el = (id) => document.getElementById(id);
      const product = el('product');
      const unitPrice = el('unitPrice');
      const portionWeight = el('portionWeight');
      const issuedPortions = el('issuedPortions');
      const issuedKg = el('issuedKg');
      const closingPortions = el('closingPortions');
      const closingKg = el('closingKg');
      const actualSales = el('actualSales');
      const cash = el('cash');
      const flatRate = el('flatRate');
      const commissionRate = el('commissionRate');
      const marketFees = el('marketFees');
      const advancedMarketFees = el('advancedMarketFees');

      const kpiDis = el('kpi-discrepancy');
      const kpiCom = el('kpi-commission');
      const kpiTotal = el('kpi-total');

      const form = el('sales-form');
      const tbody = el('tbody');

      el('year').textContent = new Date().getFullYear();
      el('source-link').href = '#';

      const STORAGE_KEY = 'ba_payment_records_v1_2';
      const loadRecords = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const saveRecords = (rows) => localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));

      const applyProductDefaults = () => {
        const d = defaults[product.value];
        unitPrice.value = d.price;
        portionWeight.value = d.weight;
        compute();
      };

      product.addEventListener('change', applyProductDefaults);

      const compute = () => {
        const w = num(portionWeight.value);
        const issuedP = num(issuedPortions.value);
        const closingP = num(closingPortions.value);
        const price = num(unitPrice.value);

        const issuedK = issuedP * w;
        const closingK = closingP * w;

        issuedKg.value = KG3(issuedK);
        closingKg.value = KG3(closingK);

        const actual = (issuedP - closingP) * price;
        actualSales.value = UGX(actual);

        const discrepancy = UGX(actual) - UGX(num(cash.value));
        const commission = UGX((num(commissionRate.value) / 100) * UGX(actual));
        const totalToPay = UGX(commission - discrepancy);

        kpiDis.textContent = UGX(discrepancy).toLocaleString();
        kpiCom.textContent = UGX(commission).toLocaleString();
        kpiTotal.textContent = UGX(totalToPay).toLocaleString();
      };

      ['input','change'].forEach(evt => {
        [portionWeight, issuedPortions, closingPortions, unitPrice, cash, commissionRate, flatRate].forEach(x => x.addEventListener(evt, compute));
      });

      (function init(){
        commissionRate.value = 20;
        flatRate.value = 5000;
        el('date').valueAsDate = new Date();
        applyProductDefaults();
        compute();
        renderTable();
      })();

      function ensureRequired(){
        const fields = ['date','sa','area'];
        for(const id of fields){ if(!el(id).value) { alert('Please fill: ' + id); return false; } }
        return true;
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if(!ensureRequired()) return;
        compute();
        const row = collectFormData();
        const rows = loadRecords();
        rows.unshift(row);
        saveRecords(rows);
        renderTable();
        form.reset();
        el('date').valueAsDate = new Date();
        commissionRate.value = 20; flatRate.value = 5000; applyProductDefaults(); compute();
      });

      function collectFormData() {
        const date = el('date').value;
        const channel = el('channel').value;
        const prod = product.value;
        const sa = el('sa').value;
        const area = el('area').value;
        const price = UGX(num(unitPrice.value));
        const weight = Number(num(portionWeight.value).toFixed(3));
        const issuedP = UGX(num(issuedPortions.value));
        const issuedK = Number((num(issuedPortions.value) * num(portionWeight.value)).toFixed(3));
        const closingP = UGX(num(closingPortions.value));
        const closingK = Number((num(closingPortions.value) * num(portionWeight.value)).toFixed(3));
        const cashCollected = UGX(num(cash.value));
        const actual = UGX((num(issuedPortions.value) - num(closingPortions.value)) * num(unitPrice.value));
        const rate = Number(num(commissionRate.value));
        const commission = UGX((rate / 100) * actual);
        const flat = UGX(num(flatRate.value));
        const discrepancy = UGX(actual - cashCollected);
        const totalToPay = UGX(commission - discrepancy);
        const mFees = UGX(num(marketFees.value));
        const aFees = UGX(num(advancedMarketFees.value));

        return {
          date,
          channel,
          prod,
          sa,
          area,
          price,
          weight,
          issuedP,
          issuedK,
          closingP,
          closingK,
          cashCollected,
          actual,
          discrepancy,
          rate,
          commission,
          flat,
          totalToPay,
          marketFees: mFees,
          advancedMarketFees: aFees
        };
      }

      function renderTable() {
        const rows = loadRecords();
        tbody.innerHTML = '';
        rows.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.date}</td>
            <td>${r.channel}</td>
            <td>${r.prod}</td>
            <td>${r.sa}</td>
            <td>${r.area}</td>
            <td>${(r.price||0).toLocaleString()}</td>
            <td>${(r.weight||0).toFixed(3)}</td>
            <td>${r.issuedP||0}</td>
            <td>${(r.issuedK||0).toFixed(3)}</td>
            <td>${r.closingP||0}</td>
            <td>${(r.closingK||0).toFixed(3)}</td>
            <td>${(r.cashCollected||0).toLocaleString()}</td>
            <td>${(r.actual||0).toLocaleString()}</td>
            <td>${(r.discrepancy||0).toLocaleString()}</td>
            <td>${r.rate||0}</td>
            <td>${(r.commission||0).toLocaleString()}</td>
            <td>${(r.flat||0).toLocaleString()}</td>
            <td>${(r.totalToPay||0).toLocaleString()}</td>
            <td>${(r.marketFees||0).toLocaleString()}</td>
            <td>${(r.advancedMarketFees||0).toLocaleString()}</td>
            <td><button class="btn" data-del="${idx}">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-del]');
        if(!btn) return;
        const idx = Number(btn.dataset.del);
        const rows = loadRecords();
        rows.splice(idx, 1);
        saveRecords(rows);
        renderTable();
      });

      el('reset-form').addEventListener('click', () => {
        form.reset();
        el('date').valueAsDate = new Date();
        commissionRate.value = 20; flatRate.value = 5000; applyProductDefaults(); compute();
      });

      [cash, marketFees, advancedMarketFees].forEach(x => x.addEventListener('input', compute));

      document.getElementById('export-xlsx').addEventListener('click', () => {
        const rows = loadRecords();
        if(rows.length === 0) return alert('No data to export');
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'BA payment');
        XLSX.writeFile(wb, 'ba_payment.xlsx');
      });
    </script>
  </body>
</html>
