<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tofu Hawking – Field Assistant</title>
  <style>
    :root{--bg:#f8f8f8;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;--accent:#b45309;--ok:#065f46;--bad:#991b1b;--ring:#f59e0b}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    h1{font-size:22px;margin:10px 0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.06);padding:18px;margin-bottom:18px;border:1px solid #eee}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:var(--ink);outline:none}
    input:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(245,158,11,.2)}
    .row{display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;background:#111827;color:#fff}
    .btn.secondary{background:#f3f4f6;color:#111827}
    .btn.warn{background:#f59e0b}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .right{justify-content:flex-end}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:auto}
    th,td{padding:10px 12px;border-bottom:1px solid #eee;text-align:left;white-space:nowrap}
    th{font-size:12px;color:#6b7280}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:#ecfdf5;color:var(--ok)}
    .bad{background:#fef2f2;color:var(--bad)}
    .accent{color:var(--accent)}
    .note{font-size:12px;color:var(--muted)}
    .totals{font-weight:600}
    .divider{height:1px;background:#eee;margin:10px 0}
  </style>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Tofu Hawking – Field Assistant</h1>
    <div class="card">
      <div class="grid">
        <div class="col-3"><label>Date</label><input type="date" id="date" /></div>
        <div class="col-3"><label>SA name</label><input id="sa" placeholder="e.g., Nicholas"/></div>
        <div class="col-3"><label>Unit price – in kg (UGX)</label><input id="pKg" type="number" inputmode="numeric" value="10000"/></div>
        <div class="col-3"><label>Unit price – in portion (UGX)</label><input id="pPortion" type="number" inputmode="numeric" value="500"/></div>

        <div class="col-3"><label>Stock issued – in kg</label><input id="issuedKg" type="number" step="0.01"/></div>
        <div class="col-3"><label>Stock issued – in portion</label><input id="issuedPortion" type="number" step="1"/></div>
        <div class="col-3"><label>Balance – in kg</label><input id="balKg" type="number" step="0.01"/></div>
        <div class="col-3"><label>Balance – in portion</label><input id="balPortion" type="number" step="1"/></div>

        <div class="col-3"><label>Cash collected (UGX)</label><input id="cash" type="number" inputmode="numeric"/></div>
        <div class="col-3"><label>Commission rate</label>
          <div class="row"><input id="rate" type="number" min="0" max="100" value="20"/><span class="note">%</span></div>
        </div>
        <div class="col-6 right"><button class="btn" id="add">Add entry</button></div>
      </div>
      <div class="divider"></div>
      <div class="grid">
        <div class="col-3"><label>Total value of stock given (UGX)</label><div id="vStock" class="accent">0</div></div>
        <div class="col-3"><label>Discrepancies (UGX)</label><div id="disc" class="accent">0</div></div>
        <div class="col-3"><label>Commission (UGX)</label><div id="comm" class="accent">0</div></div>
        <div class="col-3"><label>Total amount to be paid (UGX)</label><div id="toPay" class="accent">0</div></div>
      </div>
      <div class="note" style="margin-top:8px">Formulae: Value of stock = (issuedKg*pKg)+(issuedPortion*pPortion). Discrepancies = Value of stock − Cash collected. Commission = Cash*rate%. Amount to be paid = Commission − MAX(Discrepancies,0) + (balKg*pKg)+(balPortion*pPortion).</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Entries</strong>
        <div>
          <button class="btn secondary" id="exportXLSX">Export XLSX</button>
          <button class="btn secondary" id="export">Export CSV</button>
          <button class="btn warn" id="clear">Clear all</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>Date</th><th>SA</th>
              <th>Unit/kg</th><th>Unit/portion</th>
              <th>Stock value</th>
              <th>Issued kg</th><th>Issued portion</th>
              <th>Balance kg</th><th>Balance portion</th>
              <th>Cash</th><th>Discrep.</th><th>Comm.</th><th>To pay</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr class="totals">
              <td colspan="4">Totals</td>
              <td id="tStock">0</td>
              <td id="tIssuedKg">0</td>
              <td id="tIssuedPortion">0</td>
              <td id="tBalKg">0</td>
              <td id="tBalPortion">0</td>
              <td id="tCash">0</td>
              <td id="tDisc">0</td>
              <td id="tComm">0</td>
              <td id="tPay">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="note">Data is saved locally on this device (browser localStorage).</div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const fmt = n => (isNaN(n)?0:n).toLocaleString('en-UG',{maximumFractionDigits:0});

    const inputs = ['date','sa','pKg','pPortion','issuedKg','issuedPortion','balKg','balPortion','cash','rate'].map(el);
    inputs.forEach(i=> i.addEventListener('input', recalc));

    function numbers(){
      return {
        pKg:+el('pKg').value||0,
        pPortion:+el('pPortion').value||0,
        issuedKg:+el('issuedKg').value||0,
        issuedPortion:+el('issuedPortion').value||0,
        balKg:+el('balKg').value||0,
        balPortion:+el('balPortion').value||0,
        cash:+el('cash').value||0,
        rate:+el('rate').value||0
      }
    }

    function calc(){
      const n = numbers();
      const stockVal = (n.issuedKg*n.pKg) + (n.issuedPortion*n.pPortion);
      const disc = stockVal - n.cash; // positive = shortfall
      const comm = n.cash * (n.rate/100);
      const toPay = comm - Math.max(disc,0) + (n.balKg*n.pKg) + (n.balPortion*n.pPortion);
      return {stockVal,disc,comm,toPay};
    }

    function recalc(){
      const {stockVal,disc,comm,toPay} = calc();
      el('vStock').textContent = fmt(stockVal);
      el('disc').textContent = fmt(disc);
      el('comm').textContent = fmt(comm);
      el('toPay').textContent = fmt(toPay);
    }

    function load(){
      const raw = localStorage.getItem('tofu-hawking-entries');
      return raw? JSON.parse(raw): [];
    }
    function save(rows){
      localStorage.setItem('tofu-hawking-entries', JSON.stringify(rows));
    }

    function render(){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML='';
      const rows = load();
      let t={stock:0,issuedKg:0,issuedPortion:0,balKg:0,balPortion:0,cash:0,disc:0,comm:0,pay:0};
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date||''}</td>
          <td>${r.sa||''}</td>
          <td>${fmt(r.pKg)}</td>
          <td>${fmt(r.pPortion)}</td>
          <td>${fmt(r.stockVal)}</td>
          <td>${fmt(r.issuedKg)}</td>
          <td>${fmt(r.issuedPortion)}</td>
          <td>${fmt(r.balKg)}</td>
          <td>${fmt(r.balPortion)}</td>
          <td>${fmt(r.cash)}</td>
          <td><span class="pill ${r.disc>0?'bad':'ok'}">${fmt(r.disc)}</span></td>
          <td>${fmt(r.comm)}</td>
          <td>${fmt(r.toPay)}</td>`;
        tbody.appendChild(tr);
        t.stock+=r.stockVal; t.issuedKg+=r.issuedKg; t.issuedPortion+=r.issuedPortion;
        t.balKg+=r.balKg; t.balPortion+=r.balPortion; t.cash+=r.cash; t.disc+=r.disc; t.comm+=r.comm; t.pay+=r.toPay;
      });
      el('tStock').textContent=fmt(t.stock);
      el('tIssuedKg').textContent=fmt(t.issuedKg);
      el('tIssuedPortion').textContent=fmt(t.issuedPortion);
      el('tBalKg').textContent=fmt(t.balKg);
      el('tBalPortion').textContent=fmt(t.balPortion);
      el('tCash').textContent=fmt(t.cash);
      el('tDisc').textContent=fmt(t.disc);
      el('tComm').textContent=fmt(t.comm);
      el('tPay').textContent=fmt(t.pay);
    }

    el('add').addEventListener('click', ()=>{
      const n = numbers();
      const {stockVal,disc,comm,toPay} = calc();
      const row = {
        date: el('date').value, sa: el('sa').value,
        pKg:n.pKg, pPortion:n.pPortion,
        issuedKg:n.issuedKg, issuedPortion:n.issuedPortion,
        balKg:n.balKg, balPortion:n.balPortion,
        cash:n.cash, stockVal, disc, comm, toPay
      };
      const rows = load(); rows.push(row); save(rows); render();
      ['issuedKg','issuedPortion','balKg','balPortion','cash'].forEach(id=> el(id).value='');
      recalc();
    });

    el('clear').addEventListener('click', ()=>{ if(confirm('Delete all saved entries on this device?')){ save([]); render(); } });

    // CSV export
    el('export').addEventListener('click', ()=>{
      const rows = load();
      if(!rows.length){alert('No entries to export.');return;}
      const headers = ['Date','SA','Unit/kg','Unit/portion','Stock value','Issued kg','Issued portion','Balance kg','Balance portion','Cash','Discrepancies','Commission','To pay'];
      const csv = [headers.join(',')].concat(rows.map(r=>[
        r.date,r.sa,r.pKg,r.pPortion,r.stockVal,r.issuedKg,r.issuedPortion,r.balKg,r.balPortion,r.cash,r.disc,r.comm,r.toPay
      ].join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='tofu-hawking-entries.csv'; a.click();
    });

    // XLSX export using SheetJS
    el('exportXLSX').addEventListener('click', ()=>{
      const rows = load();
      if(!rows.length){alert('No entries to export.');return;}
      const data = [
        ['Date','SA','Unit/kg','Unit/portion','Stock value','Issued kg','Issued portion','Balance kg','Balance portion','Cash','Discrepancies','Commission','To pay'],
        ...rows.map(r=>[
          r.date, r.sa, r.pKg, r.pPortion, r.stockVal, r.issuedKg, r.issuedPortion, r.balKg, r.balPortion, r.cash, r.disc, r.comm, r.toPay
        ])
      ];
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Entries');
      XLSX.writeFile(wb, 'tofu-hawking-entries.xlsx');
    });

    // init
    el('date').valueAsDate = new Date();
    recalc();
    render();
  </script>
</body>
</html>
