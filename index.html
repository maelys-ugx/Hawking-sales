<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BA payment</title>
    <meta name="description" content="BA payment – Record and calculate daily agent sales." />

    <style>
      :root {
        --beige: #f6f3dd;
        --green: #028b43;
        --orange: #f8a925;
        --bg: var(--beige);
        --text: #0b1220;
        --muted: #475569;
        --card: #ffffff;
        --border: #e5e7eb;
      }
      * { box-sizing: border-box; }
      html, body { margin:0; padding:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background: var(--bg); color: var(--text); }
      a { color: var(--green); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .container { width: min(1100px, 94%); margin: 0 auto; }
      header { position: sticky; top: 0; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--beige) 65%, #fff 35%); border-bottom: 1px solid var(--border); z-index: 10; }
      .nav { display:flex; align-items:center; justify-content:space-between; padding: 14px 0; }
      .brand { display:flex; align-items:center; gap:10px; font-weight:800; }
      .logo { width: 30px; height: 30px; border-radius: 10px; background: var(--green); color: #fff; display:grid; place-items:center; font-weight:900; }
      .menu { display:flex; gap:16px; color: var(--muted); }

      main { padding: 26px 0; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: 0 6px 20px rgba(2,139,67,0.06); }
      .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
      .span-12 { grid-column: span 12; }
      .span-6 { grid-column: span 12; }
      @media (min-width: 860px){ .span-6{ grid-column: span 6; } }

      h1 { font-size: clamp(28px, 4vw, 40px); margin: 10px 0 0; }
      h2 { font-size: 20px; margin: 0 0 12px; }
      h3 { font-size: 16px; margin: 6px 0 10px; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; }

      .hero { padding: 28px 0 10px; }
      .eyebrow { color: var(--muted); font-weight: 700; letter-spacing: .12em; text-transform: uppercase; font-size: 12px; }
      .cta { margin-top: 14px; display:flex; gap:10px; flex-wrap: wrap; }

      .btn { border: 1px solid var(--border); background: #fff; color: var(--text); padding: 10px 16px; border-radius: 12px; font-weight: 700; cursor: pointer; }
      .btn.primary { background: var(--green); color: #fff; border-color: transparent; }
      .btn.warn { background: var(--orange); color:#222; border-color: transparent; }
      .pill { border-radius: 999px; padding: 6px 10px; background: #fef3c7; color: #92400e; font-weight: 700; font-size: 12px; }

      form .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; margin-bottom: 12px; }
      label { font-size: 12px; color: var(--muted); font-weight: 700; letter-spacing:.02em; }
      input, select { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background: #fff; color: var(--text); font-size: 14px; }
      input[readonly] { background: #f8fafc; color:#475569; }

      .kpi { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
      .kpi .tile { grid-column: span 12; border:1px dashed var(--border); border-radius: 16px; padding: 14px; background: #fff; }
      .kpi .value { font-size: 22px; font-weight: 800; }
      .kpi .caption { color: var(--muted); font-size: 12px; }
      @media (min-width: 860px){ .kpi .tile.sm-4{ grid-column: span 4; } }

      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid var(--border); text-align: left; padding: 8px; font-size: 13px; }
      thead th { position: sticky; top: 0; background: #fff8ee; z-index: 1; }
      tbody tr:hover { background: #f9fafb; }

      footer { border-top: 1px solid var(--border); color: var(--muted); padding: 18px 0 40px; font-size: 14px; }
    </style>
  </head>
  <body>
    <!-- ... header, hero, and form unchanged ... -->

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
      // ===== Helpers =====
      const UGX = (n) => (isFinite(n) ? Math.round(Number(n)) : 0);
      const KG3 = (n) => (isFinite(n) ? Number(n).toFixed(3) : (0).toFixed(3));
      const num = (n) => (n === '' || n === null || n === undefined ? 0 : Number(n));

      const defaults = {
        Kikalayi: { price: 500,  weight: 0.03  },
        Skewers:  { price: 1000, weight: 0.045 },
      };

      const el = (id) => document.getElementById(id);
      const product = el('product');
      const unitPrice = el('unitPrice');
      const portionWeight = el('portionWeight');
      const issuedPortions = el('issuedPortions');
      const issuedKg = el('issuedKg');
      const closingPortions = el('closingPortions');
      const closingKg = el('closingKg');
      const actualSales = el('actualSales');
      const cash = el('cash');
      const flatRate = el('flatRate');
      const commissionRate = el('commissionRate');
      const marketFees = el('marketFees');
      const advancedMarketFees = el('advancedMarketFees');

      const kpiDis = el('kpi-discrepancy');
      const kpiCom = el('kpi-commission');
      const kpiTotal = el('kpi-total');
      const form = el('sales-form');
      const tbody = el('tbody');

      el('year').textContent = new Date().getFullYear();
      el('source-link').href = '#';

      const STORAGE_KEY = 'ba_payment_records_v1_2';
      const loadRecords = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const saveRecords = (rows) => localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));

      const getDefaultsFor = (name) => {
        const key = String(name || '').toLowerCase().trim();
        if (key.startsWith('kikal')) return defaults.Kikalayi;
        if (key.startsWith('skewer')) return defaults.Skewers;
        return null;
      };

      const applyProductDefaults = () => {
        const val = (product.value || '').trim();
        if (!val) {
          unitPrice.value = 0;
          portionWeight.value = 0;
        } else {
          const d = getDefaultsFor(val) || defaults.Kikalayi;
          unitPrice.value = d.price;
          portionWeight.value = d.weight;
        }
        compute();
      };

      // ✅ version corrigée
      function applyChannelDefaults(){
        const ch = el('channel').value;
        if (ch === 'Market sales') {
          commissionRate.value = 20;
          flatRate.value = 5000;
        } else if (ch === 'Hawking') {
          commissionRate.value = 20;
          flatRate.value = 0;
        } else {
          commissionRate.value = 0;
          flatRate.value = 0;
        }
        compute();
      }

      // (reste du code inchangé : compute, renderTable, etc.)
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/Hawking-sales/sw.js', { scope: '/Hawking-sales/' })
          .catch(console.error);
      }
    </script>
  </body>
</html>
