<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BA payment</title>
    <meta name="description" content="BA payment – Record and calculate daily agent sales." />

    <style>
      :root {
        --beige: #f6f3dd;
        --green: #028b43;
        --orange: #f8a925;
        --bg: var(--beige);
        --text: #0b1220;
        --muted: #475569;
        --card: #ffffff;
        --border: #e5e7eb;
      }
      * { box-sizing: border-box; }
      html, body { margin:0; padding:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background: var(--bg); color: var(--text); }
      a { color: var(--green); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .container { width: min(1100px, 94%); margin: 0 auto; }
      header { position: sticky; top: 0; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--beige) 65%, #fff 35%); border-bottom: 1px solid var(--border); z-index: 10; }
      .nav { display:flex; align-items:center; justify-content:space-between; padding: 14px 0; }
      .brand { display:flex; align-items:center; gap:10px; font-weight:800; }
      .logo { width: 30px; height: 30px; border-radius: 10px; background: var(--green); color: #fff; display:grid; place-items:center; font-weight:900; }
      .menu { display:flex; gap:16px; color: var(--muted); }

      main { padding: 26px 0; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: 0 6px 20px rgba(2,139,67,0.06); }
      .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
      .span-12 { grid-column: span 12; }
      .span-6 { grid-column: span 12; }
      @media (min-width: 860px){ .span-6{ grid-column: span 6; } }

      h1 { font-size: clamp(28px, 4vw, 40px); margin: 10px 0 0; }
      h2 { font-size: 20px; margin: 0 0 12px; }
      h3 { font-size: 16px; margin: 6px 0 10px; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; }

      .hero { padding: 28px 0 10px; }
      .eyebrow { color: var(--muted); font-weight: 700; letter-spacing: .12em; text-transform: uppercase; font-size: 12px; }
      .cta { margin-top: 14px; display:flex; gap:10px; flex-wrap: wrap; }

      .btn { border: 1px solid var(--border); background: #fff; color: #000; padding: 10px 16px; border-radius: 12px; font-weight: 700; cursor: pointer; }
      .btn.primary { background: var(--green); color: #fff; border-color: transparent; }
      .btn.warn { background: var(--orange); color:#222; border-color: transparent; }
      .pill { border-radius: 999px; padding: 6px 10px; background: #fef3c7; color: #92400e; font-weight: 700; font-size: 12px; }

      form .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; margin-bottom: 12px; }
      label { font-size: 12px; color: var(--muted); font-weight: 700; letter-spacing:.02em; }
      input, select { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background: #fff; color: var(--text); font-size: 14px; }
      input[readonly] { background: #f8fafc; color:#475569; }

      .kpi { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
      .kpi .tile { grid-column: span 12; border:1px dashed var(--border); border-radius: 16px; padding: 14px; background: #fff; }
      .kpi .value { font-size: 22px; font-weight: 800; }
      .kpi .caption { color: var(--muted); font-size: 12px; }
      @media (min-width: 860px){ .kpi .tile.sm-4{ grid-column: span 4; } }

      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid var(--border); text-align: left; padding: 8px; font-size: 13px; }
      thead th { position: sticky; top: 0; background: #fff8ee; z-index: 1; }
      tbody tr:hover { background: #f9fafb; }

      footer { border-top: 1px solid var(--border); color: var(--muted); padding: 18px 0 40px; font-size: 14px; }
    </style>
  </head>
  <body>
    <header>
      <div class="container nav">
        <div class="brand">
          <div class="logo" aria-hidden="true">BA</div>
          <span>BA payment</span>
        </div>
        <nav class="menu" aria-label="Main navigation">
          <span class="pill">v1.2</span>
        </nav>
      </div>
    </header>

    <div class="container hero">
      <p class="eyebrow">Daily agent sales</p>
      <h1>Record, compute & export</h1>
      <p style="max-width:760px">BA payment is a lightweight, single-page web app (HTML/CSS/JS, in English) designed to record and automatically calculate daily sales data for selling agents. It stores records locally in the browser, with options to export data to .xlsx.</p>
      <div class="cta">
        <a class="btn primary" href="#form">Record data</a>
        <!-- Clear all data button is placed in the form actions -->
      </div>
    </div>

    <main class="container">
      <section class="card" id="form">
        <h2>New record</h2>
        <form id="sales-form" autocomplete="off">

          <!-- General information -->
          <h3>General information</h3>
          <div class="row">
            <div class="span-6">
              <label for="date">Date</label>
              <input type="date" id="date" required />
            </div>
            <div class="span-6">
              <label for="channel">Sales channel</label>
              <select id="channel" required>
                <option value="">—</option>
                <option value="Market sales">Market sales</option>
                <option value="Hawking">Hawking</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="span-6">
              <label for="product">Product</label>
              <select id="product" required>
                <option value="">—</option>
                <option value="Kikalayi">Kikalayi</option>
                <option value="Skewers">Skewers</option>
              </select>
            </div>
            <div class="span-6">
              <label for="sa">SA name</label>
              <input type="text" id="sa" placeholder="Agent name" required />
            </div>
          </div>
          <div class="row">
            <div class="span-12">
              <label for="area">Selling area</label>
              <input type="text" id="area" placeholder="Area / Market" required />
            </div>
          </div>

          <!-- Product -->
          <h3>Product</h3>
          <div class="row">
            <div class="span-6">
              <label for="unitPrice">Unit price (UGX)</label>
              <input type="number" id="unitPrice" step="1" min="0" />
            </div>
            <div class="span-6">
              <label for="portionWeight">Portion weight (kg)</label>
              <input type="number" id="portionWeight" step="0.001" min="0" />
            </div>
          </div>
          <div class="row">
            <div class="span-6">
              <label for="issuedPortions">Stock issued (portions)</label>
              <input type="number" id="issuedPortions" step="1" min="0" />
            </div>
            <div class="span-6">
              <label for="issuedKg">Stock issued (kg)</label>
              <input type="number" id="issuedKg" step="0.001" readonly />
            </div>
          </div>
          <div class="row">
            <div class="span-6">
              <label for="closingPortions">Closing balance (portions)</label>
              <input type="number" id="closingPortions" step="1" min="0" />
            </div>
            <div class="span-6">
              <label for="closingKg">Closing balance (kg)</label>
              <input type="number" id="closingKg" step="0.001" readonly />
            </div>
          </div>

          <!-- Financial data -->
          <h3>Financial data</h3>
          <div class="row">
            <div class="span-6">
              <label for="cash">Cash collected (UGX)</label>
              <input type="number" id="cash" step="1" min="0" />
            </div>
            <div class="span-6">
              <label for="actualSales">Actual sales (UGX)</label>
              <input type="number" id="actualSales" step="1" min="0" readonly />
            </div>
          </div>
          <div class="row">
            <div class="span-6">
              <label for="flatRate">Flat wedge (UGX)</label>
              <input type="number" id="flatRate" step="1" min="0" />
            </div>
            <div class="span-6">
              <label for="commissionRate">Commission rate (%)</label>
              <input type="number" id="commissionRate" step="0.1" min="0" max="100" />
            </div>
          </div>

          <div class="kpi" style="margin-top: 6px;">
            <div class="tile sm-4">
              <div class="caption">Discrepancies (UGX)</div>
              <div class="value" id="kpi-discrepancy">0</div>
            </div>
            <div class="tile sm-4">
              <div class="caption">Commission (UGX)</div>
              <div class="value" id="kpi-commission">0</div>
            </div>
            <div class="tile sm-4">
              <div class="caption">Total amount to be paid (UGX)</div>
              <div class="value" id="kpi-total">0</div>
            </div>
          </div>

          <!-- Specifics -->
          <h3>Specifics</h3>
          <div class="row">
            <div class="span-6">
              <label for="marketFees">Market fees (UGX)</label>
              <input type="number" id="marketFees" step="1" min="0" />
            </div>
            <div class="span-6">
              <label for="advancedMarketFees">Advanced market fees (UGX)</label>
              <input type="number" id="advancedMarketFees" step="1" min="0" />
            </div>
          </div>

          <div class="cta" style="margin-top: 14px;">
            <button class="btn primary" type="submit">Record data</button>
            <button class="btn" type="button" id="reset-form">Reset</button>
            <button class="btn warn" type="button" id="clear-data">Clear all data</button>
          </div>
        </form>
      </section>

      <section class="card" id="records" style="margin-top:14px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <h2 style="margin:0">Records</h2>
          <div class="cta">
            <button class="btn warn" id="export-xlsx">Export XLSX</button>
          </div>
        </div>

        <div style="overflow:auto; max-height: 55vh; margin-top:10px; border:1px solid var(--border); border-radius: 12px;">
          <table id="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Channel</th>
                <th>Product</th>
                <th>SA name</th>
                <th>Area</th>
                <th>Unit price (UGX)</th>
                <th>Portion weight (kg)</th>
                <th>Issued (portions)</th>
                <th>Issued (kg)</th>
                <th>Closing (portions)</th>
                <th>Closing (kg)</th>
                <th>Cash collected (UGX)</th>
                <th>Actual sales (UGX)</th>
                <th>Discrepancies (UGX)</th>
                <th>Commission rate (%)</th>
                <th>Commission (UGX)</th>
                <th>Flat wedge (UGX)</th>
                <th>Total to pay (UGX)</th>
                <th>Market fees (UGX)</th>
                <th>Advanced market fees (UGX)</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer>
      <div class="container">
        <small>
          © <span id="year"></span> BA payment — Built for GitHub Pages. | <a id="source-link" href="#">Source code</a>
        </small>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
      // ===== Helpers =====
      const UGX = (n) => (isFinite(n) ? Math.round(Number(n)) : 0);
      const KG3 = (n) => (isFinite(n) ? Number(n).toFixed(3) : (0).toFixed(3));
      const num = (n) => (n === '' || n === null || n === undefined ? 0 : Number(n));

      // Defaults per product
      const defaults = {
        Kikalayi: { price: 500,  weight: 0.03  },
        Skewers:  { price: 1000, weight: 0.045 },
      };

      // Elements
      const el = (id) => document.getElementById(id);
      const product = el('product');
      const unitPrice = el('unitPrice');
      const portionWeight = el('portionWeight');
      const issuedPortions = el('issuedPortions');
      const issuedKg = el('issuedKg');
      const closingPortions = el('closingPortions');
      const closingKg = el('closingKg');
      const actualSales = el('actualSales');
      const cash = el('cash');
      const flatRate = el('flatRate'); // "Flat wedge" en UI
      const commissionRate = el('commissionRate');
      const marketFees = el('marketFees');
      const advancedMarketFees = el('advancedMarketFees');

      const kpiDis = el('kpi-discrepancy');
      const kpiCom = el('kpi-commission');
      const kpiTotal = el('kpi-total');

      const form = el('sales-form');
      const tbody = el('tbody');

      // Footer info
      el('year').textContent = new Date().getFullYear();
      el('source-link').href = '#';

      // Local storage
      const STORAGE_KEY = 'ba_payment_records_v1_2';
      const loadRecords = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const saveRecords = (rows) => localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));

      // --- Defaults mapping ---
      const getDefaultsFor = (name) => {
        const key = String(name || '').toLowerCase().trim();
        if (key.startsWith('kikal')) return defaults.Kikalayi;
        if (key.startswith('skewer')) return defaults.Skewers;
        return null;
      };

      // Initialise defaults produit (met 0 si pas de produit)
      const applyProductDefaults = () => {
        const val = (product.value || '').trim();
        if (!val) {
          unitPrice.value = 0;
          portionWeight.value = 0;
        } else {
          const d = getDefaultsFor(val) || defaults.Kikalayi;
          unitPrice.value = d.price;
          portionWeight.value = d.weight;
        }
        compute();
      };

      // Règle canal → flat & commission par défaut (commission vide si canal vide)
      function applyChannelDefaults(){
        const ch = el('channel').value;

        if (ch === 'Market sales') {
          flatRate.value = 5000;
          commissionRate.value = 20;   // 20%
        } else if (ch === 'Hawking') {
          flatRate.value = 0;
          commissionRate.value = 20;   // 20%
        } else if (ch === '') {
          flatRate.value = 0;
          commissionRate.value = '';   // affichage vide (calculé comme 0)
        }
        compute();
      }

      // Anti scroll sur inputs number
      document.addEventListener('wheel', (e) => {
        const t = e.target;
        if (t && t.tagName === 'INPUT' && t.type === 'number') t.blur();
      }, { passive: true });

      // Fees-only mode
      function isFeesOnlyMode(){
        return num(marketFees.value) > 0 || num(advancedMarketFees.value) > 0;
      }

      // Champs required (General + Product + Financial) sauf si fees-only
      function updateRequired(){
        const feesOnly = isFeesOnlyMode();
        el('date').required = true;

        const requiredIds = [
          'channel','product','sa','area',
          'unitPrice','portionWeight','issuedPortions','closingPortions',
          'cash','commissionRate','flatRate'
        ];
        requiredIds.forEach(id => {
          const node = el(id);
          if (!node) return;
          node.required = !feesOnly;
        });
      }

      // Vérification stricte au submit
      function ensureRequired(){
        if (!el('date').value) { alert('Please fill: Date'); return false; }
        if (isFeesOnlyMode()) return true;

        const fields = [
          ['channel','Sales channel'],
          ['product','Product'],
          ['sa','SA name'],
          ['area','Selling area'],
          ['unitPrice','Unit price'],
          ['portionWeight','Portion weight'],
          ['issuedPortions','Stock issued (portions)'],
          ['closingPortions','Closing balance (portions)'],
          ['cash','Cash collected'],
          ['commissionRate','Commission rate'],
          ['flatRate','Flat wedge']
        ];

        for (const [id,label] of fields){
          const n = el(id);
          if (!n || n.value === '' || n.value === null) {
            alert('Please fill: ' + label);
            return false;
          }
        }
        return true;
      }

      // Alerte si cash > ventes (discrepancy négative)
      let warnedCashOver = false;

      // Live compute (commission vide traitée comme 0 si canal vide)
      const compute = () => {
        const w = num(portionWeight.value);
        const issuedP = num(issuedPortions.value);
        const closingP = num(closingPortions.value);
        const price = num(unitPrice.value);

        const issuedK = issuedP * w;
        const closingK = closingP * w;

        issuedKg.value = KG3(issuedK);
        closingKg.value = KG3(closingK);

        const actual = (issuedP - closingP) * price;
        actualSales.value = UGX(actual);

        const ch = el('channel').value;
        const effectiveRate = (ch === '' ? 0 : num(commissionRate.value));
        const flatVal      = (ch === '' ? 0 : UGX(num(flatRate.value)));

        const discrepancy = UGX(actual) - UGX(num(cash.value));            // actual - cash
        const commission  = UGX((effectiveRate / 100) * UGX(actual));
        const totalToPay  = UGX(flatVal + commission - discrepancy);

        kpiDis.textContent   = UGX(discrepancy).toLocaleString();
        kpiCom.textContent   = UGX(commission).toLocaleString();
        kpiTotal.textContent = UGX(totalToPay).toLocaleString();

        if (discrepancy < 0) {
          if (!warnedCashOver) {
            alert(`Warning: Cash collected exceeds computed sales by ${Math.abs(discrepancy).toLocaleString()} UGX. Please review price, issued/closing quantities, and cash entry.`);
            warnedCashOver = true;
          }
        } else {
          warnedCashOver = false;
        }
      };

      // Set initial values
      function setToday() {
        const d = el('date');
        try { d.valueAsDate = new Date(); }
        catch { d.value = new Date().toISOString().slice(0,10); }
      }

      (function init(){
        commissionRate.value = '';  // vide tant que le canal n'est pas choisi
        flatRate.value = 5000;      // valeur par défaut visuelle; sera corrigée par applyChannelDefaults()
        setToday();
        applyChannelDefaults();     // applique 20% si canal déjà choisi, sinon vide + flat=0
        applyProductDefaults();     // met 0 si pas de produit sélectionné
        compute();
        renderTable();
        updateRequired();
      })();

      // Écouteurs
      ['input','change'].forEach(evt => {
        [product, portionWeight, issuedPortions, closingPortions, unitPrice, cash, commissionRate, flatRate]
          .forEach(x => x.addEventListener(evt, compute));
      });
      ['change','input'].forEach(evt => product.addEventListener(evt, applyProductDefaults));
      ['change','input'].forEach(evt => el('channel').addEventListener(evt, applyChannelDefaults));
      [marketFees, advancedMarketFees].forEach(x => {
        x.addEventListener('input', updateRequired);
        x.addEventListener('change', updateRequired);
      });

      // Collect form values + computed
      function collectFormData(){
        const date = el('date').value;
        const channel = el('channel').value;
        const prod = product.value;
        const sa = el('sa').value;
        const area = el('area').value;
        const price = UGX(num(unitPrice.value));
        const weight = Number(num(portionWeight.value).toFixed(3));
        const issuedP = UGX(num(issuedPortions.value));
        const issuedK = Number((num(issuedPortions.value) * num(portionWeight.value)).toFixed(3));
        const closingP = UGX(num(closingPortions.value));
        const closingK = Number((num(closingPortions.value) * num(portionWeight.value)).toFixed(3));
        const cashCollected = UGX(num(cash.value));
        const actual = UGX((num(issuedPortions.value) - num(closingPortions.value)) * num(unitPrice.value));

        const effectiveRate = (channel === '' ? 0 : Number(num(commissionRate.value)));
        const commission = UGX((effectiveRate/100) * actual);
        const flat = (channel === '' ? 0 : UGX(num(flatRate.value)));

        const discrepancy = UGX(actual - cashCollected);
        const totalToPay  = UGX(flat + commission - discrepancy);
        const mFees = UGX(num(marketFees.value));
        const aFees = UGX(num(advancedMarketFees.value));

        return {
          date, channel, prod, sa, area,
          price, weight, issuedP, issuedK, closingP, closingK,
          cashCollected, actual, discrepancy, rate: effectiveRate, commission, flat, totalToPay,
          marketFees: mFees, advancedMarketFees: aFees
        };
      }

      // Render table (Commission rate avec %)
      function renderTable(){
        const rows = loadRecords();
        tbody.innerHTML = '';
        rows.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.date}</td>
            <td>${r.channel||''}</td>
            <td>${r.prod||''}</td>
            <td>${r.sa||''}</td>
            <td>${r.area||''}</td>
            <td>${(r.price||0).toLocaleString()}</td>
            <td>${(r.weight||0).toFixed(3)}</td>
            <td>${r.issuedP||0}</td>
            <td>${(r.issuedK||0).toFixed(3)}</td>
            <td>${r.closingP||0}</td>
            <td>${(r.closingK||0).toFixed(3)}</td>
            <td>${(r.cashCollected||0).toLocaleString()}</td>
            <td>${(r.actual||0).toLocaleString()}</td>
            <td>${(r.discrepancy||0).toLocaleString()}</td>
            <td>${(r.rate != null && r.rate !== '' ? r.rate + '%' : '0%')}</td>
            <td>${(r.commission||0).toLocaleString()}</td>
            <td>${(r.flat||0).toLocaleString()}</td>
            <td>${(r.totalToPay||0).toLocaleString()}</td>
            <td>${(r.marketFees||0).toLocaleString()}</td>
            <td>${(r.advancedMarketFees||0).toLocaleString()}</td>
            <td><button class="btn" data-del="${idx}">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Delete row
      tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-del]');
        if(!btn) return;
        const idx = Number(btn.dataset.del);
        const rows = loadRecords();
        rows.splice(idx, 1);
        saveRecords(rows);
        renderTable();
      });

      // Submit
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if(!ensureRequired()) return;
        compute();
        const row = collectFormData();
        const rows = loadRecords();
        rows.unshift(row);
        saveRecords(rows);
        renderTable();
        form.reset();
        setToday();
        commissionRate.value = '';  // reste vide après enregistrement
        flatRate.value = 5000;
        applyChannelDefaults();
        applyProductDefaults();
        compute();
        updateRequired();
      });

      // Reset form
      el('reset-form').addEventListener('click', () => {
        form.reset();
        setToday();
        commissionRate.value = '';  // vide tant que canal non choisi
        flatRate.value = 5000;
        applyChannelDefaults();
        applyProductDefaults();
        compute();
        updateRequired();
      });

      // Clear all data
      document.getElementById('clear-data').addEventListener('click', () => {
        if(confirm('Clear all saved records?')) {
          saveRecords([]);
          renderTable();
        }
      });

      // Recompute when these change
      [cash, marketFees, advancedMarketFees].forEach(x => x.addEventListener('input', compute));

      // Export XLSX (nom auto: BA Payment - YYYYMMDD.xlsx + entêtes lisibles)
      document.getElementById('export-xlsx').addEventListener('click', () => {
        const rows = loadRecords();
        if(rows.length === 0) return alert('No data to export');

        const headerMap = {
          date: 'Date',
          channel: 'Sales channel',
          prod: 'Product',
          sa: 'SA name',
          area: 'Selling area',
          price: 'Unit price (UGX)',
          weight: 'Portion weight (kg)',
          issuedP: 'Stock issued (portions)',
          issuedK: 'Stock issued (kg)',
          closingP: 'Closing balance (portions)',
          closingK: 'Closing balance (kg)',
          cashCollected: 'Cash collected (UGX)',
          actual: 'Actual sales (UGX)',
          discrepancy: 'Discrepancies (UGX)',
          rate: 'Commission rate (%)',
          commission: 'Commission (UGX)',
          flat: 'Flat wedge (UGX)',
          totalToPay: 'Total amount to be paid (UGX)',
          marketFees: 'Market fees (UGX)',
          advancedMarketFees: 'Advanced market fees (UGX)'
        };

        const exportRows = rows.map(r => {
          const o = {};
          for (const [k,label] of Object.entries(headerMap)) {
            o[label] = r[k];
          }
          return o;
        });

        const ws = XLSX.utils.json_to_sheet(exportRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'BA payment');

        const pad = (n)=> String(n).padStart(2,'0');
        const d = new Date();
        const fname = `BA Payment - ${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}.xlsx`;

        XLSX.writeFile(wb, fname);
      });
    </script>

    <!-- Service worker (corrigé) -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/Hawking-sales/sw.js', { scope: '/Hawking-sales/' })
          .catch(console.error);
      }
    </script>
  </body>
</html>
